<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TrinhHG Admin Panel</title>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e293b; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; margin-bottom: -2px; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; font-size: 14px; }
        th { background: #f8fafc; }
        .btn { padding: 5px 10px; cursor: pointer; color: white; border: none; border-radius: 4px; }
        .btn-approve { background: #10b981; }
        .btn-reject { background: #ef4444; }
        .btn-refresh { background: #3b82f6; margin-bottom: 10px; padding: 10px 20px; font-weight: bold; }
        
        .badge-match { background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .badge-mismatch { background: #fee2e2; color: #991b1b; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        
        /* Manual Tool CSS */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input { padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .gen-btn { width: 100%; background: #2563eb; color: white; padding: 10px; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ADMIN PANEL</h1>
        <div class="tabs">
            <div class="tab" onclick="switchTab('create')">T·∫°o Key Th·ªß C√¥ng</div>
            <div class="tab active" onclick="switchTab('approve')">Duy·ªát Key T·∫°m</div>
        </div>

        <div id="create" class="panel">
            <h3>T·∫°o Key Th·ªß C√¥ng</h3>
            <p>S·ª≠ d·ª•ng khi kh√°ch mua tr·ª±c ti·∫øp ho·∫∑c t·∫∑ng key. Copy JSON b√™n d∆∞·ªõi v√† d√°n v√†o KV Namespace.</p>
            <div class="grid-2">
                <div><label>Lo·∫°i:</label><select id="mn-type" style="width:100%;padding:8px;"><option value="permanent">Official</option><option value="temp">Temp</option></select></div>
                <div><label>Thi·∫øt b·ªã:</label><input type="number" id="mn-dev" value="2"></div>
                <div><label>Ng√†y:</label><input type="number" id="mn-days" value="30"></div>
                <div><label>Ghi ch√∫:</label><input type="text" id="mn-note" placeholder="T√™n kh√°ch"></div>
            </div>
            <button class="gen-btn" onclick="genManual()">T·∫†O DATA</button>
            <textarea id="mn-out" style="width:100%; height:100px; margin-top:10px; font-family:monospace;"></textarea>
        </div>

        <div id="approve" class="panel active">
            <button class="btn btn-refresh" onclick="loadTempKeys()">üîÑ L√†m m·ªõi danh s√°ch</button>
            <table>
                <thead>
                    <tr>
                        <th>Key T·∫°m</th>
                        <th>M√£ GD (N·ªôi dung CK)</th>
                        <th>S·ªë ti·ªÅn nh·∫≠n</th>
                        <th>Kh·ªõp G√≥i?</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="temp-table-body">
                    <tr><td colspan="5">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const ADMIN_SECRET = "trinhhg_admin_secret_123";

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'approve') loadTempKeys();
        }

        async function loadTempKeys() {
            const tbody = document.getElementById('temp-table-body');
            tbody.innerHTML = '<tr><td colspan="5">ƒêang t·∫£i...</td></tr>';
            try {
                const res = await fetch('/api/admin/list-temp', { headers: { 'x-admin-secret': ADMIN_SECRET } });
                if(!res.ok) throw new Error("Auth Failed");
                const data = await res.json();
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Kh√¥ng c√≥ key t·∫°m n√†o c·∫ßn duy·ªát.</td></tr>'; return; }

                data.forEach(item => {
                    const row = document.createElement('tr');
                    const paid = item.paid_amount || 0;
                    
                    // Logic ki·ªÉm tra s·ªë ti·ªÅn (G·ª£i √Ω m√†u s·∫Øc)
                    let statusHtml = '<span class="badge-mismatch">?</span>';
                    let btnColor = 'background:#ccc';
                    
                    // Logic ƒëo√°n g√≥i (C√° nh√¢n 40k, Team 80k...)
                    if(paid >= 40000) statusHtml = '<span class="badge-match">G√≥i Th√°ng</span>';
                    else if(paid >= 15000) statusHtml = '<span class="badge-match">G√≥i Tu·∫ßn</span>';
                    else statusHtml = '<span class="badge-mismatch">L·∫ª / Sai</span>';

                    row.innerHTML = `
                        <td style="font-family:monospace; color:#2563eb;">${item.key}</td>
                        <td>${item.trans_code} <br> <small style="color:#666">${item.raw_message || ''}</small></td>
                        <td style="font-weight:bold;">${paid.toLocaleString()} ƒë</td>
                        <td>${statusHtml}</td>
                        <td>
                            <button class="btn btn-approve" onclick="upgradeKey('${item.key}', ${paid})">DUY·ªÜT</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch(e) { tbody.innerHTML = `<tr><td colspan="5" style="color:red">L·ªói: ${e.message}. Ki·ªÉm tra l·∫°i Secret Key.</td></tr>`; }
        }

        async function upgradeKey(key, amount) {
            let days = 30; // M·∫∑c ƒë·ªãnh
            if(amount < 20000) days = 7;
            
            const finalDays = prompt(`Duy·ªát key n√†y th√†nh bao nhi√™u ng√†y?\n(Ti·ªÅn nh·∫≠n: ${amount.toLocaleString()}ƒë)`, days);
            if(!finalDays) return;

            try {
                const res = await fetch('/api/admin/upgrade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': ADMIN_SECRET },
                    body: JSON.stringify({ key, duration: parseInt(finalDays) * 86400, devices: 2 })
                });
                const d = await res.json();
                if(d.success) { alert("ƒê√£ duy·ªát th√†nh c√¥ng!"); loadTempKeys(); }
                else alert("L·ªói: " + d.message);
            } catch(e) { alert("L·ªói k·∫øt n·ªëi server"); }
        }

        function genManual() {
            const type = document.getElementById('mn-type').value;
            const dev = parseInt(document.getElementById('mn-dev').value);
            const days = parseInt(document.getElementById('mn-days').value);
            const note = document.getElementById('mn-note').value;
            
            const key = (type==='permanent' ? 'VIP-' : 'TEMP-') + Math.random().toString(36).substr(2, 8).toUpperCase();
            const data = {
                type: type, status: type==='permanent' ? 'official' : 'temp',
                duration_seconds: days * 86400,
                max_devices: dev,
                devices: [],
                activated_at: null,
                expires_at: null,
                note: note
            };
            
            document.getElementById('mn-out').value = `KEY: ${key}\nVALUE: ${JSON.stringify(data)}`;
        }
        
        loadTempKeys();
    </script>
</body>
</html>
