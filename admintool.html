<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TrinhHG Admin Panel</title>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e293b; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; margin-bottom: -2px; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; font-size: 14px; }
        th { background: #f8fafc; }
        .btn { padding: 5px 10px; cursor: pointer; color: white; border: none; border-radius: 4px; }
        .btn-approve { background: #10b981; }
        .btn-refresh { background: #3b82f6; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ADMIN PANEL</h1>
        <div class="tabs">
            <div class="tab" onclick="switchTab('create')">Tạo Key</div>
            <div class="tab active" onclick="switchTab('approve')">Duyệt Key Tạm</div>
        </div>

        <div id="approve" class="panel active">
            <button class="btn btn-refresh" onclick="loadTempKeys()">Làm mới danh sách</button>
            <table>
                <thead>
                    <tr>
                        <th>Key Tạm</th>
                        <th>Mã GD</th>
                        <th>Số tiền</th>
                        <th>Thời gian tạo</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="temp-table-body">
                    <tr><td colspan="5">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="create" class="panel">
            <p>Form tạo key thủ công (Copy từ code cũ nếu cần)...</p>
        </div>
    </div>

    <script>
        const ADMIN_SECRET = "trinhhg_admin_secret_123";

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'approve') loadTempKeys();
        }

        async function loadTempKeys() {
            const tbody = document.getElementById('temp-table-body');
            tbody.innerHTML = '<tr><td colspan="5">Đang tải...</td></tr>';
            try {
                const res = await fetch('/api/admin/list-temp', { headers: { 'x-admin-secret': ADMIN_SECRET } });
                const data = await res.json();
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Không có key tạm nào</td></tr>'; return; }

                data.forEach(item => {
                    const row = document.createElement('tr');
                    const paid = item.paid_amount ? item.paid_amount.toLocaleString() + ' đ' : '0 đ';
                    const time = new Date(item.activated_at).toLocaleString('vi-VN');
                    row.innerHTML = `
                        <td>${item.key}</td>
                        <td>${item.trans_code || '-'}</td>
                        <td style="color:green; font-weight:bold;">${paid}</td>
                        <td>${time}</td>
                        <td>
                            <button class="btn btn-approve" onclick="upgradeKey('${item.key}', ${item.paid_amount || 0})">DUYỆT NGAY</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch(e) { alert('Lỗi tải danh sách: ' + e); }
        }

        async function upgradeKey(key, amount) {
            // Tự động tính ngày dựa trên số tiền (Logic gợi ý)
            let days = 30; // Mặc định 1 tháng
            if(amount < 40000 && amount > 10000) days = 7;
            if(amount >= 80000) days = 60;

            const finalDays = prompt(`Duyệt key này bao nhiêu ngày? (Tiền nhận: ${amount.toLocaleString()}đ)`, days);
            if(!finalDays) return;

            try {
                const res = await fetch('/api/admin/upgrade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': ADMIN_SECRET },
                    body: JSON.stringify({ key, duration: parseInt(finalDays) * 86400, devices: 2 })
                });
                const d = await res.json();
                if(d.success) { alert("Đã duyệt thành công!"); loadTempKeys(); }
                else alert("Lỗi server");
            } catch(e) { alert(e); }
        }

        // Load mặc định
        loadTempKeys();
    </script>
</body>
</html>
