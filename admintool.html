<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TrinhHG Admin Panel</title>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e293b; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; margin-bottom: -2px; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; font-size: 14px; }
        th { background: #f8fafc; }
        .btn { padding: 6px 12px; cursor: pointer; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .btn-approve { background: #10b981; }
        .btn-refresh { background: #3b82f6; margin-bottom: 10px; }
        
        .badge-match { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; }
        .badge-mismatch { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select { padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .gen-btn { width: 100%; background: #2563eb; color: white; padding: 10px; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ADMIN PANEL</h1>
        <div class="tabs">
            <div class="tab" onclick="switchTab('create')">T·∫°o Key Th·ªß C√¥ng</div>
            <div class="tab active" onclick="switchTab('approve')">Duy·ªát Key T·∫°m</div>
        </div>

        <div id="create" class="panel">
            <h3>T·∫°o Key Th·ªß C√¥ng</h3>
            <p>Copy JSON b√™n d∆∞·ªõi v√† d√°n v√†o Cloudflare KV Namespace n·∫øu c·∫ßn.</p>
            <div class="grid-2">
                <div><label>Lo·∫°i:</label><select id="mn-type"><option value="permanent">Official</option><option value="temp">Temp</option></select></div>
                <div><label>Thi·∫øt b·ªã:</label><input type="number" id="mn-dev" value="2"></div>
                <div><label>Ng√†y:</label><input type="number" id="mn-days" value="30"></div>
                <div><label>Ghi ch√∫:</label><input type="text" id="mn-note" placeholder="T√™n kh√°ch"></div>
            </div>
            <button class="gen-btn" onclick="genManual()">T·∫†O DATA JSON</button>
            <textarea id="mn-out" style="width:100%; height:100px; margin-top:10px; font-family:monospace;"></textarea>
        </div>

        <div id="approve" class="panel active">
            <button class="btn btn-refresh" onclick="loadTempKeys()">üîÑ L√†m m·ªõi danh s√°ch</button>
            <table>
                <thead>
                    <tr>
                        <th>Key T·∫°m</th>
                        <th>M√£ GD & N·ªôi dung</th>
                        <th>S·ªë ti·ªÅn nh·∫≠n</th>
                        <th>Tr·∫°ng th√°i ti·ªÅn</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="temp-table-body">
                    <tr><td colspan="5">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const ADMIN_SECRET = "trinhhg_admin_secret_123";

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'approve') loadTempKeys();
        }

        async function loadTempKeys() {
            const tbody = document.getElementById('temp-table-body');
            tbody.innerHTML = '<tr><td colspan="5">ƒêang t·∫£i...</td></tr>';
            try {
                // Fetch v·ªõi header ƒë√∫ng ƒë·ªÉ kh√¥ng b·ªã CORS n·∫øu server x·ª≠ l√Ω ƒë√∫ng OPTIONS
                const res = await fetch('/api/admin/list-temp', { 
                    method: 'GET',
                    headers: { 'x-admin-secret': ADMIN_SECRET, 'Content-Type': 'application/json' } 
                });
                
                if(!res.ok) throw new Error("Auth Failed or API Error");
                const data = await res.json();
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Kh√¥ng c√≥ key t·∫°m n√†o c·∫ßn duy·ªát.</td></tr>'; return; }

                data.forEach(item => {
                    const row = document.createElement('tr');
                    const paid = item.paid_amount || 0;
                    
                    // Logic ki·ªÉm tra s·ªë ti·ªÅn (Xanh/ƒê·ªè)
                    let statusHtml = '';
                    let actionBtn = '';

                    // M·ªëc gi√°: 15k (7 ng√†y), 40k (30 ng√†y), 80k (Team)
                    if (paid >= 40000) {
                        statusHtml = `<span class="badge-match">‚úÖ ƒê·ªß G√≥i Th√°ng (${paid.toLocaleString()})</span>`;
                        actionBtn = `<button class="btn btn-approve" onclick="upgradeKey('${item.key}', 30, 2)">DUY·ªÜT 30 NG√ÄY</button>`;
                    } else if (paid >= 15000) {
                        statusHtml = `<span class="badge-match">‚úÖ ƒê·ªß G√≥i Tu·∫ßn (${paid.toLocaleString()})</span>`;
                        actionBtn = `<button class="btn btn-approve" onclick="upgradeKey('${item.key}', 7, 2)">DUY·ªÜT 7 NG√ÄY</button>`;
                    } else if (paid > 0) {
                        statusHtml = `<span class="badge-mismatch">‚ö†Ô∏è L·∫ª/Thi·∫øu (${paid.toLocaleString()})</span>`;
                        actionBtn = `<button class="btn btn-approve" style="background:#f59e0b" onclick="upgradeKey('${item.key}', 1, 2)">DUY·ªÜT 1 NG√ÄY</button>`;
                    } else {
                        statusHtml = `<span class="badge-mismatch">‚ùå Ch∆∞a c√≥ ti·ªÅn (0ƒë)</span>`;
                        actionBtn = `<button class="btn" style="background:#94a3b8; cursor:not-allowed;">CH·ªú TI·ªÄN</button>`;
                    }

                    row.innerHTML = `
                        <td style="font-family:monospace; color:#2563eb;">${item.key}</td>
                        <td>
                            <b>${item.trans_code}</b><br>
                            <small style="color:#666">${item.raw_message || 'N/A'}</small>
                        </td>
                        <td style="font-weight:bold;">${paid.toLocaleString()} ƒë</td>
                        <td>${statusHtml}</td>
                        <td>${actionBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch(e) { tbody.innerHTML = `<tr><td colspan="5" style="color:red">L·ªói: ${e.message}</td></tr>`; }
        }

        async function upgradeKey(key, days, devs) {
            if(!confirm(`Duy·ªát key n√†y th√†nh ${days} ng√†y?`)) return;

            try {
                const res = await fetch('/api/admin/upgrade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': ADMIN_SECRET },
                    body: JSON.stringify({ key, duration: days * 86400, devices: devs })
                });
                const d = await res.json();
                if(d.success) { alert("ƒê√£ duy·ªát th√†nh c√¥ng!"); loadTempKeys(); }
                else alert("L·ªói: " + d.message);
            } catch(e) { alert("L·ªói k·∫øt n·ªëi server"); }
        }

        function genManual() {
            const type = document.getElementById('mn-type').value;
            const dev = parseInt(document.getElementById('mn-dev').value);
            const days = parseInt(document.getElementById('mn-days').value);
            const note = document.getElementById('mn-note').value;
            
            const key = (type==='permanent' ? 'VIP-' : 'TEMP-') + Math.random().toString(36).substr(2, 8).toUpperCase();
            const data = {
                type: type, status: type==='permanent' ? 'official' : 'temp',
                duration_seconds: days * 86400,
                max_devices: dev,
                devices: [],
                activated_at: null,
                expires_at: null,
                note: note
            };
            
            document.getElementById('mn-out').value = `KEY: ${key}\nVALUE: ${JSON.stringify(data)}`;
        }
        
        loadTempKeys();
    </script>
</body>
</html>
