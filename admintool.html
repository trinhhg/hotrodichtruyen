<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TrinhHG Admin Panel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; color: #334155; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e293b; margin-top: 0; }
        
        .config-box { background: #eff6ff; padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #dbeafe; display: flex; align-items: center; gap: 10px; }
        .config-box input { flex: 1; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; margin-bottom: -2px; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; font-size: 13px; }
        th { background: #f8fafc; font-weight: 700; color: #475569; }
        
        .btn { padding: 6px 12px; cursor: pointer; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .btn-approve { background: #10b981; }
        .btn-reject { background: #ef4444; }
        .btn-refresh { background: #3b82f6; padding: 8px 15px; margin-bottom: 10px; width: auto; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        
        .time-left { font-family: monospace; color: #d97706; font-weight: bold; }
        
        /* Manual Tool */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select { padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .gen-btn { width: 100%; background: #2563eb; color: white; padding: 10px; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QU·∫¢N TR·ªä H·ªÜ TH·ªêNG</h1>
        
        <div class="config-box">
            <label><strong>Link Web:</strong></label>
            <input type="text" id="api-url" placeholder="https://hotrodichtruyen.pages.dev" value="https://hotrodichtruyen.pages.dev">
        </div>

        <div class="tabs">
            <div class="tab" onclick="switchTab('create')">T·∫°o Key</div>
            <div class="tab active" onclick="switchTab('approve')">Duy·ªát Key T·∫°m</div>
            <div class="tab" onclick="switchTab('official')">Key Ch√≠nh Th·ª©c</div>
        </div>

        <div id="create" class="panel">
            <h3>T·∫°o Key Th·ªß C√¥ng</h3>
            <div class="grid-2">
                <div><label>Lo·∫°i:</label><select id="mn-type"><option value="permanent">Official</option><option value="temp">Temp</option></select></div>
                <div><label>Thi·∫øt b·ªã:</label><input type="number" id="mn-dev" value="2"></div>
                <div><label>Ng√†y:</label><input type="number" id="mn-days" value="30"></div>
                <div><label>Ghi ch√∫:</label><input type="text" id="mn-note" placeholder="T√™n kh√°ch"></div>
            </div>
            <button class="gen-btn" onclick="genManual()">T·∫†O DATA JSON</button>
            <textarea id="mn-out" style="width:100%; height:100px; margin-top:10px; font-family:monospace;"></textarea>
        </div>

        <div id="approve" class="panel active">
            <button class="btn btn-refresh" onclick="loadKeys('temp')">üîÑ T·∫£i danh s√°ch Key T·∫°m</button>
            <table>
                <thead>
                    <tr>
                        <th>Key T·∫°m</th>
                        <th>Th√¥ng tin GD</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="temp-table-body">
                    <tr><td colspan="5">Ch∆∞a t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="official" class="panel">
            <button class="btn btn-refresh" onclick="loadKeys('official')">üîÑ T·∫£i danh s√°ch Key Ch√≠nh Th·ª©c</button>
            <table>
                <thead>
                    <tr>
                        <th>License Key</th>
                        <th>Ghi ch√∫ / Code</th>
                        <th>Thi·∫øt b·ªã</th>
                        <th>H·∫øt h·∫°n (C√≤n l·∫°i)</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="official-table-body">
                    <tr><td colspan="5">Ch∆∞a t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const ADMIN_SECRET = "trinhhg_admin_secret_123";

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'approve') loadKeys('temp');
            if(id === 'official') loadKeys('official');
        }

        async function loadKeys(type) {
            const baseUrl = document.getElementById('api-url').value.replace(/\/$/, "");
            const tbody = document.getElementById(type === 'temp' ? 'temp-table-body' : 'official-table-body');
            tbody.innerHTML = '<tr><td colspan="5">ƒêang t·∫£i...</td></tr>';

            try {
                // G·ªçi API l·∫•y list
                const res = await fetch(`${baseUrl}/api/admin/list?type=${type}`, { 
                    method: 'GET',
                    headers: { 'x-admin-secret': ADMIN_SECRET, 'Content-Type': 'application/json' } 
                });
                
                if(!res.ok) throw new Error("K·∫øt n·ªëi th·∫•t b·∫°i (Check Link Web)");
                const data = await res.json();
                
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>'; return; }

                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    if(type === 'temp') {
                        // LOGIC TAB TEMP
                        const paid = item.paid_amount || 0;
                        let statusHtml = '';
                        // Logic ki·ªÉm tra m√†u
                        if(paid >= 40000) statusHtml = `<span class="badge badge-green">G√≥i Th√°ng (40k)</span>`;
                        else if(paid >= 15000) statusHtml = `<span class="badge badge-green">G√≥i Tu·∫ßn (15k)</span>`;
                        else if(paid > 0) statusHtml = `<span class="badge badge-red">L·∫ª/Thi·∫øu (${paid.toLocaleString()})</span>`;
                        else statusHtml = `<span class="badge badge-red">Ch∆∞a c√≥ ti·ªÅn (0ƒë)</span>`;

                        row.innerHTML = `
                            <td style="font-family:monospace; color:#2563eb;">${item.key}</td>
                            <td><b>${item.trans_code||'-'}</b><br><small>${item.raw_message || ''}</small></td>
                            <td style="font-weight:bold;">${paid.toLocaleString()} ƒë</td>
                            <td>${statusHtml}</td>
                            <td style="display:flex; gap:5px;">
                                <button class="btn btn-approve" onclick="upgradeKey('${item.key}', ${paid})">DUY·ªÜT</button>
                                <button class="btn btn-reject" onclick="deleteKey('${item.key}')">KH√îNG DUY·ªÜT</button>
                            </td>
                        `;
                    } else {
                        // LOGIC TAB OFFICIAL
                        const timeLeft = calculateTimeLeft(item.expires_at);
                        row.innerHTML = `
                            <td style="font-family:monospace; color:#2563eb;">${item.key}</td>
                            <td>${item.note || item.trans_code || '-'}</td>
                            <td>${(item.devices||[]).length}/${item.max_devices}</td>
                            <td>${new Date(item.expires_at).toLocaleDateString('vi-VN')} <br> <span class="time-left">(${timeLeft})</span></td>
                            <td>
                                <button class="btn btn-reject" onclick="deleteKey('${item.key}')">X√ìA KEY</button>
                            </td>
                        `;
                    }
                    tbody.appendChild(row);
                });
            } catch(e) { tbody.innerHTML = `<tr><td colspan="5" style="color:red">L·ªói: ${e.message}</td></tr>`; }
        }

        function calculateTimeLeft(expiry) {
            const now = Date.now();
            const diff = expiry - now;
            if(diff <= 0) return "H·∫øt h·∫°n";
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return `${days} ng√†y ${hours} gi·ªù`;
        }

        async function upgradeKey(key, amount) {
            const baseUrl = document.getElementById('api-url').value.replace(/\/$/, "");
            let days = 30;
            if(amount < 20000) days = 7;
            const finalDays = prompt(`Duy·ªát key n√†y bao nhi√™u ng√†y?\n(Ti·ªÅn nh·∫≠n: ${amount.toLocaleString()}ƒë)`, days);
            if(!finalDays) return;

            try {
                const res = await fetch(`${baseUrl}/api/admin/upgrade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': ADMIN_SECRET },
                    body: JSON.stringify({ key, duration: parseInt(finalDays) * 86400, devices: 2 })
                });
                const d = await res.json();
                if(d.success) { alert("Th√†nh c√¥ng!"); loadKeys('temp'); }
                else alert("L·ªói: " + d.message);
            } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
        }

        async function deleteKey(key) {
            const baseUrl = document.getElementById('api-url').value.replace(/\/$/, "");
            if(!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA vƒ©nh vi·ªÖn key n√†y?\n${key}\n(Ng∆∞·ªùi d√πng s·∫Ω b·ªã ƒëƒÉng xu·∫•t ngay l·∫≠p t·ª©c)`)) return;

            try {
                const res = await fetch(`${baseUrl}/api/admin/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': ADMIN_SECRET },
                    body: JSON.stringify({ key })
                });
                const d = await res.json();
                if(d.success) { 
                    alert("ƒê√£ x√≥a key!"); 
                    // Reload current tab
                    const activeTab = document.querySelector('.tab.active').getAttribute('onclick').includes('official') ? 'official' : 'temp';
                    loadKeys(activeTab);
                }
                else alert("L·ªói: " + d.message);
            } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
        }

        function genManual() {
            const type = document.getElementById('mn-type').value;
            const dev = parseInt(document.getElementById('mn-dev').value);
            const days = parseInt(document.getElementById('mn-days').value);
            const note = document.getElementById('mn-note').value;
            const key = (type==='permanent' ? 'VIP-' : 'TEMP-') + Math.random().toString(36).substr(2, 8).toUpperCase();
            const data = {
                type: type, status: type==='permanent' ? 'official' : 'temp',
                duration_seconds: days * 86400, max_devices: dev, devices: [],
                activated_at: null, expires_at: null, note: note
            };
            document.getElementById('mn-out').value = `KEY: ${key}\nVALUE: ${JSON.stringify(data)}`;
        }
    </script>
</body>
</html>
